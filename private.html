<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>محادثة خاصة</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const app = initializeApp({databaseURL:"https://hacker-4bd68-default-rtdb.firebaseio.com"});
const db = getDatabase(app);
const storage = getStorage(app);

const me = localStorage.getItem("user");
const other = new URLSearchParams(location.search).get("u");
const chatID=[me,other].sort().join("_");

window.send = ()=>{
 if(!msg.value)return;
 push(ref(db,"private/"+chatID),{
  u:me,t:msg.value,time:Date.now()
 });
 msg.value="";
};

img.onchange=async e=>{
 const f=e.target.files[0];
 const r=sRef(storage,"private/"+Date.now());
 await uploadBytes(r,f);
 const url=await getDownloadURL(r);
 push(ref(db,"private/"+chatID),{u:me,img:url,time:Date.now()});
};

onValue(ref(db,"private/"+chatID), snap=>{
 chat.innerHTML="";
 snap.forEach(c=>{
  const d=c.val();
  chat.innerHTML+=`
  <div>${d.u}<br>
  ${d.t||""}
  ${d.img?`<img src="${d.img}" width="150">`:""}
  </div><hr>`;
 });
});
</script>
</head>

<body>
<h2>شات مع ${other}</h2>
<div id="chat"></div>

<input id="msg">
<input type="file" id="img">
<button onclick="send()">إرسال</button>
</body>
</html>
